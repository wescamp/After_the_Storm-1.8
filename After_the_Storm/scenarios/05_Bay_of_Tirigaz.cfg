#textdomain wesnoth-After_the_Storm

[scenario]
    id=05_Bay_of_Tirigaz
    name= _ "Bay of Tirigaz"
    {MAP 05_Bay_of_Tirigaz.map}
    {TURNS 40 37 35}
    next_scenario="06_Quenoth_Isle"

    {A_DEATHS}

    {SCENARIO_MUSIC       "loyalists.ogg"}
    {EXTRA_SCENARIO_MUSIC "battle.ogg"}
    {EXTRA_SCENARIO_MUSIC "breaking_the_chains.ogg"}

    {STORYTXT_BAY_OF_TIRIGAZ}

    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}
    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}
    {LONGDARK1}
    {LONGDARK2}
    {LONGDARK3}
    {LONGDARK4}

    [side]
        save_id=player

        controller=human
        side=1
        team_name=player
        user_team_name= _ "team_name^Galas"

        {GOLD 280 260 245}

        type=Elvish Wayfarer
        id=Galas
        name= _ "Galas"
        canrecruit=yes
        unrenamable=yes
        profile="portraits/galas.png"
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_QUICK}
        [/modifications]
    [/side]

    [side]
        side=2
        team_name=player
        user_team_name= _ "team_name^Tirigaz"

        {GOLD 260 240 210}
        recruit="Orcish Grunt, Orcish Archer, Wolf Rider, Goblin Spearman"

        id="Zare-gar Kon"
        name= _ "Zare-gar Kon"
        canrecruit=yes
        type=Orcish Sovereign
        unrenamable=yes
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
    [/side]

    [side]
        side=3
        team_name=player
        user_team_name= _ "team_name^Tirigaz"

        {GOLD 240 220 200}
        recruit="Goblin Spearman, Orcish Grunt, Orcish Assassin, Troll Whelp"

        id=Vitork
        name= _ "Vitork"
        canrecruit=yes
        type=Orcish Slurbow
        unrenamable=yes
        [modifications]
            {TRAIT_INTELLIGENT}
            {TRAIT_QUICK}
        [/modifications]
    [/side]

    [side]
        side=4
        team_name=player
        user_team_name= _ "team_name^Tirigaz"

        {GOLD 120 90 70}
        recruit="Goblin Spearman, Orcish Grunt, Orcish Archer"

        id=Murelgor
        name= _ "Murelgor"
        canrecruit=yes
        type=Orcish Warlord
        unrenamable=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_QUICK}
        [/modifications]
    [/side]

    [side]
        side=5
        team_name=lizards
        user_team_name= _ "Invaders"

        {GOLD 290 360 420}
        recruit="Saurian Skirmisher, Saurian Augur, Mudcrawler, Vampire Bat"

        id=Rizzalmax
        name= _ "Rizzalmax"
        canrecruit=yes
        type=Saurian Oracle
        unrenamable=yes
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
        [/modifications]

        [unit]
            type=Saurian Ambusher
            x,y=46,5
            facing=sw
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            type=Saurian Ambusher
            x,y=45,3
            facing=s
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            type=Saurian Soothsayer
            x,y=51,7
            facing=sw
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
    [/side]

    [side]
        side=6
        team_name=lizards
        user_team_name= _ "Invaders"

        {GOLD 300 350 395}
        recruit="Naga Fighter, Vampire Bat"

        id=Izaltos
        name= _ "Izaltos"
        canrecruit=yes
        type=Naga Myrmidon
        unrenamable=yes
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_QUICK}
        [/modifications]
        [unit]
            type=Naga Warrior
            x,y=12,31
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]
        [unit]
            type=Naga Warrior
            x,y=15,27
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [unit]
            type=Naga Warrior
            x,y=19,30
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]
    [/side]

    {STARTING_VILLAGES 2 40}
    {STARTING_VILLAGES 3 8 }
    {STARTING_VILLAGES 4 9 }
    {STARTING_VILLAGES 5 9 }
    {STARTING_VILLAGES 6 8 }

    {STARTING_VILLAGES 1 5 }

    [event]
        name=prestart

        {PLACE_IMAGE ("units/transport/galleon.png~FL(horiz)~RC(magenta>blue)")           4 2}
        {PLACE_IMAGE ("units/transport/transport-galleon.png~FL(horiz)~RC(magenta>blue)") 5 4}
        {PLACE_IMAGE ("units/transport/galleon.png~FL(horiz)~RC(magenta>blue)")           6 7}
        {PLACE_IMAGE ("units/transport/galleon.png~FL(horiz)~RC(magenta>blue)")           6 9}

        {PLACE_IMAGE ("items/straw-bale1.png") 46 14}
        {PLACE_IMAGE ("items/straw-bale2.png") 45 13}
        {PLACE_IMAGE ("items/grain-sheaf.png") 44 10}
        {PLACE_IMAGE ("items/straw-bale2.png") 43 15}

        {PLACE_IMAGE ("items/scarecrow.png")   46 11}
        {PLACE_IMAGE ("items/scarecrow.png")   43 16}

        {PLACE_IMAGE ("items/archery-target-right.png") 26  9}
        {PLACE_IMAGE ("items/archery-target-right.png") 27 10}
        {PLACE_IMAGE ("items/archery-target-right.png") 30  8}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat both enemy leaders")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Kri'tan")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Vuruk")}
            {OBJECTIVE_DEFEAT  ( _ "Death of an ally leader")}
            {OBJECTIVE_DEFEAT  ( _ "Turns run out")}

            {OBJECTIVE_NOTES   ({NEW_GOLD_CARRYOVER_NOTE_40})}
        )}

        {LOG_ATS_DBG "enter Tirigaz 'moveto' event generator"}

        #
        # Generate shipwreck treasure locations
        #
        {LOG_ATS_DBG "generating info sources..."}
        [set_variables]
            name=shipwreck_generator
            [value]
                gold=130
                message=_"130 gold! It seems it was a trading ship!"
            [/value]
            [value]
                gold=20
                message=_"Bah, only 20 pieces of gold. Better than nothing, I guess."
            [/value]
            [value]
                gold=5
                message=_"5 pieces of gold? Damn, these were really poor men!"
            [/value]
        [/set_variables]

        {LOG_ATS_DBG "generating location sources..."}
        [set_variables]
            name=shipwreck_locs
            [literal]
                x,y=20,20
            [/literal]
            [literal]
                x,y=18,10
            [/literal]
            [literal]
                x,y=11,26
            [/literal]
        [/set_variables]

        {LOG_ATS_DBG "serializing events..."}

        [while]
            {VARIABLE_NUMERICAL_GREATER_THAN shipwreck_generator.length 0}
            [do]
                {LOG_ATS_DBG "shipwreck_generator has $shipwreck_generator.length elements"}

                {LOG_ATS_DBG "spawn info_e..."}
                {VARIABLE_RANDOM info_e "0..$($shipwreck_generator.length-1)"}
                #
                # HACK: ENGINE BUG WORKAROUND
                # This is only needed for pre-1.7.2 versions and can be removed when compatibility is dropped
                #
                [if]
                    {VARIABLE_LEXICAL_EQUALS info_e "0..0"}
                    [then]
                        {VARIABLE info_e 0}
                    [/then]
                [/if]
                {LOG_ATS_DBG "info_e = $info_e (generated from 0..$($shipwreck_generator.length-1))"}

                {LOG_ATS_DBG "spawn loca_e..."}
                {VARIABLE_RANDOM loca_e "0..$($shipwreck_locs.length-1)"     }
                #
                # HACK: ENGINE BUG WORKAROUND
                # This is only needed for pre-1.7.2 versions and can be removed when compatibility is dropped
                #
                [if]
                    {VARIABLE_LEXICAL_EQUALS loca_e "0..0"}
                    [then]
                        {VARIABLE loca_e 0}
                    [/then]
                [/if]
                {LOG_ATS_DBG "loca_e = $loca_e (generated from 0..$($shipwreck_locs.length-1))"}

                {LOG_ATS_DBG "inserting graphic item"}

                {RANDOM ("scenery/shipwreck-1.png,scenery/shipwreck-1.png~FL(horiz)")}
                {PLACE_IMAGE $random $shipwreck_locs[$loca_e].x $shipwreck_locs[$loca_e].y}
                {CLEAR_VARIABLE random}

                {LOG_ATS_DBG "serializing 'moveto' event #$shipwreck_events.length|, primary SUF is side,x,y=1,$shipwreck_locs[$loca_e].x|,$shipwreck_locs[$loca_e].y"}

                [set_variables]
                    name=shipwreck_events
                    mode=append
                    # BEGIN: EventWML
                    [value]
                        delayed_variable_substitution=no
                        first_time_only=no
                        name=moveto

                        [filter]
                            side=1
                            x=$shipwreck_locs[$loca_e].x
                            y=$shipwreck_locs[$loca_e].y
                        [/filter]

                        [redraw][/redraw]

                        [message]
                            speaker=unit
                            message="$shipwreck_generator[$info_e].message"
                        [/message]

                        [sound]
                            name="gold.ogg"
                        [/sound]

                        [message]
                            speaker=narrator
                            image="items/gold-coins-medium.png"
                            message= _ "You retrieve $shipwreck_generator[$info_e].gold pieces of gold."
                        [/message]

                        [gold]
                            side,amount="1","$shipwreck_generator[$info_e].gold"
                        [/gold]
                    [/value]
                    # END: EventWML
                [/set_variables]

                {LOG_ATS_DBG "serialized 'moveto' event"}

                {LOG_ATS_DBG "pop shipwreck_generator..."}
                {CLEAR_VARIABLE shipwreck_generator[$info_e]}

                {LOG_ATS_DBG "pop shipwreck_locs..."}
                {CLEAR_VARIABLE      shipwreck_locs[$loca_e]}
            [/do]
        [/while]

        {LOG_ATS_DBG "spawning serialized events..."}

        {FOREACH shipwreck_events evnt_e}
            [insert_tag]
                name=event
                variable=shipwreck_events[$evnt_e]
            [/insert_tag]

            {LOG_ATS_DBG "spawned 'moveto' event #$evnt_e"}
        {NEXT evnt_e}

        {LOG_ATS_DBG "cleanup..."}

        {CLEAR_VARIABLE shipwreck_events,shipwreck_locs,shipwreck_generator}

        {LOG_ATS_DBG "exit Tirigaz 'moveto' event generator"}

        [store_unit]
            [filter]
                id=Galas
            [/filter]
            variable=galas_store
            kill=yes
        [/store_unit]

#ifdef HARD
        [terrain]
            terrain=Gs
            x,y=49,33
        [/terrain]
#endif
    [/event]

    [event]
        name=start
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The orcs controlling the Bay of Tirigaz were busy defending the port against some unwelcome guests..."
        [/message]

        [message]
            speaker=Rizzalmax
            message= _ "You filthy soft-skinned beasts, we want our swamps back! They've always been ours, and we are not planning to retreat to territory of the pointy-eared demons!"
        [/message]

        [message]
            speaker=Zare-gar Kon
            message= _ "We care little about your stupid wars at the East. We had a treaty; you cannot come here, break it by trespassing the well-established frontiers, and then ask to give you back the very lands you're stealing from us!"
        [/message]

        [message]
            speaker=Rizzalmax
            message= _ "'Well-established', you say? To the Dark Gods with you and your treaty! Since when can the words of an orc define where and how much can our waters spread? Are you suggesting to be the commanders of nature as well?"
        [/message]

        [message]
            speaker=Vitork
            message= _ "We rule over this peninsula. By entering it you agree to obey our conditions. By not agreeing, you set the fate of your pitiful kind!"
        [/message]

        [message]
            speaker=Rizzalmax
            message= _ "Let's see how well you perform when our allies start destroying your walls, then!"
        [/message]

        [message]
            speaker=Izaltos
            message= _ "Ha, ha! We'll tear thesssse puny earth-dwellersss to piecesss!"
        [/message]

        [move_unit_fake]
            x="55,$galas_store.x"
            y="33,$galas_store.y"
            type="$galas_store.type"
            side="$galas_store.side"
        [/move_unit_fake]

        [unstore_unit]
            variable=galas_store
        [/unstore_unit]

        {CLEAR_VARIABLE galas_store}

        [recall]
            id,show="Elynia","no"
        [/recall]

        [recall]
            id,show="Mal Keshar","no"
        [/recall]

        [recall]
            id,show="Kri'tan","no"
        [/recall]

        [message]
            speaker=Galas
            message= _ "That city to the northwest... is it the port of Tirigaz?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Yes... although it wasn't so well fortified during my times. Things have changed here indeed."
        [/message]

        [message]
            speaker=Galas
            message= _ "I hear some steps..."
        [/message]

        [move_unit_fake]
            side=1
            type=Orcish Crossbowman
            x=44,46
            y=26,30
        [/move_unit_fake]

        [unit]
            type=Orcish Crossbowman
            id=Vuruk
            name= _ "Vuruk"
            x,y=46,30
            side=1
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [message]
            speaker=Vuruk
            message= _ "Hello, strangers! Are you loyal to the Grand Council?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Ehm..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Yes, we are."
        [/message]

        [message]
            speaker=Vuruk
            message= _ "Nagas and saurians are besieging the port of Tirigaz, and I can't enter the city and bring some important news to our lord. I think I speak for all of us, when I say your help would be very valuable. I need to get to the city keep, but it isn't safe until those vermin are defeated!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "The enemies of our friends are our enemies. We can help you."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "(whispering) Although I wonder why those creatures are attacking them in the first place..."
        [/message]
    [/event]

    [event]
        name=turn 3

        #
        # Mandatory generic sea creatures' appearance.
        # No campaign is ever complete without this.
        #

        [message]
            speaker=Izaltos
            message= _ "Come in aid of your kin, friendsss from the deep sssea!"
        [/message]

        [unit]
            animate=yes
            side,x,y=6,5,23
            type=Sea Serpent
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            side,x,y=6,4,23
            type=Cuttle Fish
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            side,x,y=6,4,24
            type=Cuttle Fish
            facing=se
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Mal Keshar
            message= _ "Ah, hah! They have the support of some wild creatures! Nothing we cannot handle."
        [/message]
    [/event]

    [event]
        name=enemies defeated
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Vuruk
        [/filter]

        [message]
            speaker=unit
            message= _ "No! I've got to... uuugh..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Vuruk
        [/filter]

        [message]
            speaker=Galas
            message= _ "We let the orcish messenger die in the battlefield! The lord of Tirigaz is not going to like this..."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Rizzalmax
        [/filter]

        [message]
            speaker=unit
            message= _ "The treacherous ones cannot win! Eeaack..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Izaltos
        [/filter]
        [filter_second]
            [not]
                race=undead
            [/not]
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]

        [message]
            speaker=unit
            message= _ "Damn you, earth-dwellersss!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Izaltos
        [/filter]
        [filter_second]
            race=undead
            [or]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/or]
        [/filter_second]

        [message]
            speaker=unit
            message= _ "Damn you, foul minion of the undead!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            type=Cuttle Fish
            [or]
                type=Sea Serpent
            [/or]
        [/filter]

        [message]
            speaker=Izaltos
            message= _ "Noooooo! You're going to pay for that, idiotss!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            canrecruit=yes
            [and]
                side=2
                [or]
                    side=3
                [/or]
                [or]
                    side=4
                [/or]
            [/and]
        [/filter]

        [message]
            speaker=unit
            message= _ "No! The city needs my services!!"
        [/message]

        [message]
            speaker=second_unit
            message= _ "Ha, ha, ha! Die, fool!"
        [/message]

        [message]
            side=5
            [and]
                # Try to select Rizzalmax if he's alive.
                canrecruit=yes
                [or]
                    canrecruit=no
                [/or]
            [/and]
            message= _ "May this be a lesson for the orcish kind, now!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            canrecruit=yes
            [and]
                side=2
                [or]
                    side=3
                [/or]
                [or]
                    side=4
                [/or]
            [/and]
        [/filter]

        [message]
            speaker=Elynia
            message= _ "One of the commanders of the defense of Tirigaz has been slain! I don't think the city will resist for long..."
        [/message]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Murelgor
            message= _ "Ha, ha, yes! We made it!"
        [/message]

        [message]
            speaker="Zare-gar Kon"
            message= _ "This is an important battle you've helped us win, lady. We'll be eternally thankful for your assistance."
        [/message]

        [message]
            speaker=Elynia
            message= _ "It is our duty to assist our allies in these times. However, I believe this soldier has something to tell you..."
        [/message]

        [message]
            speaker=Vitork
            message= _ "Vuruk, brother, you made it! Did you discover anything new?"
        [/message]

        [message]
            speaker=Vuruk
            message= _ "Ha, indeed! I need to talk with you about it, but not now."
        [/message]

        [message]
            speaker="Zare-gar Kon"
            message= _ "I see you helped Vuruk return from his mission. Well done! So, how can we pay our debt with you?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Um, we are currently looking for transportation services. We must sail through the open ocean to find a certain island..."
        [/message]

        [message]
            speaker="Zare-gar Kon"
            message= _ "Don't take it as an offense, but only true fools would dare sail through the open ocean! Nobody has entered deeper waters and returned in one piece! Nobody knows exactly what kind of creatures inhabit the Vast Sea. Why would anyone want to travel so far into unknown waters anyway?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "We have a mission to complete, but like Vuruk's, it is not something we'd like to..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "We know the location of a certain isle where some inhabitants of the Great Continent went to. We need to gather some information from them - a mission for the Grand Council."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Uh, huh."
        [/message]

        [message]
            speaker="Zare-gar Kon"
            message= _ "The Grand Council? Why didn't you mention it in the first place? We'll do anything we can to help you in your mission. It'll be difficult to convince my men to help but at least I can get one of our fastest transport vessels for you..."
        [/message]

        [kill]
            id,fire_event,animate=Vuruk,no,no
        [/kill]
    [/event]
[/scenario]
